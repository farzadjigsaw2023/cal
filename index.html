<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>USDJPY Advanced Calc</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --accent-primary: #6366f1;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --input-bg: #0f172a;
            --border: #334155;
            --buy-color: #10b981;
            --sell-color: #f43f5e;
            --radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 15px;
        }

        .app-container {
            width: 100%;
            max-width: 400px;
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }

        .header h1 {
            text-align: center;
            font-size: 1.5rem;
            letter-spacing: 2px;
            margin-bottom: 25px;
            color: var(--accent-primary);
        }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.75rem; color: var(--text-dim); margin-bottom: 5px; font-weight: 700; text-transform: uppercase; }
        
        input {
            width: 100%;
            background: var(--input-bg);
            border: 1.5px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            outline: none;
            transition: 0.2s;
        }

        input:focus { border-color: var(--accent-primary); }
        input:read-only { background: rgba(0,0,0,0.2); color: var(--accent-primary); }

        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        .pill-group { display: flex; gap: 5px; background: var(--input-bg); padding: 5px; border-radius: 10px; border: 1.5px solid var(--border); }
        .pill { flex: 1; border: none; background: transparent; color: var(--text-dim); padding: 8px; border-radius: 7px; font-size: 0.8rem; font-weight: 700; cursor: pointer; }
        .pill.active { background: var(--accent-primary); color: white; }

        .atr-toggle-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0 10px;
            padding: 10px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 10px;
        }

        .switch { position: relative; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #475569; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background: var(--accent-primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        .action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; }
        .btn { padding: 15px; border: none; border-radius: 12px; font-weight: 800; color: white; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
        .btn-buy { background: var(--buy-color); }
        .btn-sell { background: var(--sell-color); }
        .btn:active { transform: scale(0.95); }

        .result-box {
            margin-top: 25px;
            padding: 20px;
            background: #0f172a;
            border-radius: var(--radius);
            display: none;
            border: 1px solid var(--accent-primary);
        }

        .res-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; }
        .res-val { font-weight: 800; color: var(--accent-primary); }
        .res-lot { text-align: center; font-size: 1.8rem; font-weight: 900; color: #fff; margin-bottom: 15px; }
        .res-lot small { display: block; font-size: 0.7rem; color: var(--text-dim); }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header"><h1>USDJPY CALC</h1></div>
    
    <form id="calcForm">
        <div class="input-group">
            <label>Account Balance ($)</label>
            <input type="number" id="balance">
        </div>

        <div class="row">
            <div class="input-group">
                <label>Risk %</label>
                <div class="pill-group">
                    <button type="button" class="pill active" onclick="setRisk(0.5, this)">0.5</button>
                    <button type="button" class="pill" onclick="setRisk(1, this)">1.0</button>
                </div>
                <input type="hidden" id="riskVal" value="0.5">
            </div>
            <div class="input-group">
                <label>Entry Price</label>
                <input type="number" id="entry" step="0.001">
            </div>
        </div>

        <div class="atr-toggle-area">
            <span style="font-size: 0.8rem; font-weight: 800;">USE ATR FOR SL</span>
            <label class="switch">
                <input type="checkbox" id="atrToggle" checked onchange="toggleATR()">
                <span class="slider"></span>
            </label>
        </div>

        <div id="atrInputs" class="row">
            <div class="input-group">
                <label>ATR Value</label>
                <input type="number" id="atrValue" step="0.001">
            </div>
            <div class="input-group">
                <label>Multiplier</label>
                <input type="number" id="atrMult" step="0.1" value="2.5">
            </div>
        </div>

        <div class="row">
            <div class="input-group">
                <label>TP (Pips)</label>
                <input type="number" id="tpPips">
            </div>
            <div class="input-group">
                <label id="slLabel">SL (Pips)</label>
                <input type="number" id="slPips">
            </div>
        </div>

        <div class="action-btns">
            <button type="button" class="btn btn-sell" onclick="calculate('short')">Sell</button>
            <button type="button" class="btn btn-buy" onclick="calculate('long')">Buy</button>
        </div>
    </form>

    <div id="result" class="result-box"></div>
</div>

<script>
    // خالی کردن همه فیلدها هنگام رفرش
    window.onload = () => {
        document.getElementById('calcForm').reset();
        toggleATR();
    };

    function setRisk(val, el) {
        document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('riskVal').value = val;
    }

    function toggleATR() {
        const isAtr = document.getElementById('atrToggle').checked;
        const slInput = document.getElementById('slPips');
        const atrSection = document.getElementById('atrInputs');
        
        atrSection.style.opacity = isAtr ? "1" : "0.3";
        atrSection.style.pointerEvents = isAtr ? "auto" : "none";
        slInput.readOnly = isAtr;
        document.getElementById('slLabel').innerText = isAtr ? "SL (Calculated)" : "SL (Manual)";
        if(isAtr) slInput.value = ""; 
    }

    function fillRandoms() {
        const balance = document.getElementById('balance');
        const entry = document.getElementById('entry');
        const atr = document.getElementById('atrValue');
        const tp = document.getElementById('tpPips');
        const sl = document.getElementById('slPips');
        const isAtr = document.getElementById('atrToggle').checked;

        if (!balance.value) balance.value = 10000;
        if (!entry.value) entry.value = (Math.random() * (155 - 145) + 145).toFixed(3);
        if (isAtr && !atr.value) atr.value = (Math.random() * (0.6 - 0.2) + 0.2).toFixed(3);
        if (!tp.value) tp.value = 50;
        if (!isAtr && !sl.value) sl.value = 20;
    }

    function calculate(side) {
        // ۱. پر کردن فیلدهای خالی قبل از هر چیز
        fillRandoms();

        const bal = parseFloat(document.getElementById('balance').value);
        const riskP = parseFloat(document.getElementById('riskVal').value);
        const entry = parseFloat(document.getElementById('entry').value);
        const tpPips = parseFloat(document.getElementById('tpPips').value);
        const isAtr = document.getElementById('atrToggle').checked;
        
        let slPips;

        // ۲. منطق ATR: محاسبه پیپ و قرار دادن در باکس SL
        if (isAtr) {
            const atr = parseFloat(document.getElementById('atrValue').value);
            const mult = parseFloat(document.getElementById('atrMult').value);
            slPips = (atr * mult) / 0.01; 
            document.getElementById('slPips').value = slPips.toFixed(1); // نمایش در ورودی
        } else {
            slPips = parseFloat(document.getElementById('slPips').value);
        }

        const riskAmount = bal * (riskP / 100);
        // محاسبه لات سایز برای USDJPY
        const pipValue = (100000 * 0.01) / entry;
        const lotSize = riskAmount / (slPips * pipValue);

        // محاسبه قیمت‌ها
        const slPrice = side === 'long' ? entry - (slPips * 0.01) : entry + (slPips * 0.01);
        const tpPrice = side === 'long' ? entry + (tpPips * 0.01) : entry - (tpPips * 0.01);
        const rr = (tpPips / slPips).toFixed(2);

        // نمایش نتایج
        const resDiv = document.getElementById('result');
        resDiv.style.display = 'block';
        resDiv.innerHTML = `
            <div class="res-lot"><small>LOT SIZE</small>${lotSize.toFixed(2)}</div>
            <div class="res-row"><span>TP Price:</span><span class="res-val">${tpPrice.toFixed(3)}</span></div>
            <div class="res-row"><span>SL Price:</span><span class="res-val">${slPrice.toFixed(3)}</span></div>
            <div class="res-row"><span>Risk Amount:</span><span class="res-val" style="color:#f43f5e">$${riskAmount.toFixed(2)}</span></div>
            <div class="res-row"><span>R:R Ratio:</span><span class="res-val">1 : ${rr}</span></div>
        `;
    }
</script>

</body>
</html>
